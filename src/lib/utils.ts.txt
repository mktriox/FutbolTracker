import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"
import { addDays, addWeeks, addMonths, differenceInYears, startOfWeek, endOfWeek, format } from 'date-fns';
import type { SuspensionUnit } from '@/types';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


export function calculateEndDate(startDate: Date, duration: number, unit: SuspensionUnit): Date {
  switch (unit) {
    case 'days':
      return addDays(startDate, duration); // If duration is 1 day, player is free on startDate + 1 day
    case 'dates': // 'dates' represents weekends/match days (assuming 1 match day per week/round)
      return addWeeks(startDate, duration); // If duration is 1 'date', player is free after 1 week
    case 'months':
      return addMonths(startDate, duration); // If duration is 1 month, player is free after 1 month
    default:
      return startDate;
  }
}


export function calculateAge(birthDate: Date, referenceDate: Date = new Date()): number {
  return differenceInYears(referenceDate, birthDate);
}

// Example function to format dates consistently
export function formatDate(date: Date | string | number): string {
  try {
      return format(new Date(date), 'dd/MM/yyyy');
  } catch (error) {
      console.error("Error formatting date:", date, error);
      return "Invalid Date";
  }
}

// Function to check if a date is within a suspension period
// Assumes suspension.endDate is exclusive (the day the player becomes free)
export function isSuspended(suspension: { startDate: Date, endDate: Date }, checkDate: Date = new Date()): boolean {
  const normalizedCheckDate = new Date(checkDate);
  normalizedCheckDate.setHours(0, 0, 0, 0);
  
  const normalizedStartDate = new Date(suspension.startDate);
  normalizedStartDate.setHours(0, 0, 0, 0);

  const normalizedEndDate = new Date(suspension.endDate); // This is the day they become free
  normalizedEndDate.setHours(0, 0, 0, 0);

  return normalizedCheckDate >= normalizedStartDate && normalizedCheckDate < normalizedEndDate;
}

// --- RUT Validation ---

/**
 * Calculates the verification digit (DV) for a Chilean RUT number body.
 * @param rutBody The RUT number without the verification digit (e.g., "12345678").
 * @returns The calculated verification digit ('0'-'9' or 'K').
 */
export function calculateRutDv(rutBody: string): string {
  const rutClean = rutBody.replace(/[^0-9]/g, ''); // Ensure only numbers
  if (!rutClean) return ''; // Return empty if no valid number part

  let M = 0;
  let S = 1;
  for (let T = parseInt(rutClean, 10); T; T = Math.floor(T / 10)) {
    S = (S + T % 10 * (9 - M++ % 6)) % 11;
  }
  return S ? (S - 1).toString() : 'K';
}

/**
 * Validates a Chilean RUT number (including the verification digit).
 * @param rut The full RUT string (e.g., "12.345.678-9" or "123456789").
 * @returns True if the RUT is valid, false otherwise.
 */
export function validateRut(rut: string | null | undefined): boolean {
  if (!rut) return false;

  const rutClean = rut.replace(/[^0-9kK]/g, '').toUpperCase(); // Keep numbers and K
  if (rutClean.length < 2) return false; // Must have at least number and DV

  const body = rutClean.slice(0, -1);
  const dv = rutClean.slice(-1);

  // Ensure body contains only numbers
  if (!/^\d+$/.test(body)) {
      return false;
  }

  return calculateRutDv(body) === dv;
}

/**
 * Formats a RUT string by adding dots and hyphen.
 * @param rut The RUT string (e.g., "123456789" or "12345678K").
 * @returns Formatted RUT string (e.g., "12.345.678-9" or "12.345.678-K") or the original string if invalid.
 */
export function formatRut(rut: string | null | undefined): string {
    if (!rut) return "";
    const rutClean = rut.replace(/[^0-9kK]/g, '').toUpperCase();
    if (rutClean.length < 2) return rut; // Return original if too short

    const body = rutClean.slice(0, -1);
    const dv = rutClean.slice(-1);

    // Ensure body contains only numbers before formatting
    if (!/^\d+$/.test(body)) {
        return rut; // Return original if body is not numeric
    }

    let formattedBody = "";
    let count = 0;
    for (let i = body.length - 1; i >= 0; i--) {
        formattedBody = body[i] + formattedBody;
        count++;
        if (count === 3 && i !== 0) {
            formattedBody = "." + formattedBody;
            count = 0;
        }
    }

    return `${formattedBody}-${dv}`;
}